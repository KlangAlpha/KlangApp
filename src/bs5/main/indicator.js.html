<script>
$(document).ready(async function(){
   
    await getplugin();
})
</script>

<script>
     const {shell} = require('electron')
     
     
     iohost = "http://127.0.0.1:9088/user"
     //iohost = "http://192.168.1.20:9088/user"
    
     const VueApp = {
       data() {
           return {
               online:0,
               work:0,
               toask:"",			
               result:[],
               server_count:0,
               pages:{
                 page:[],
                 curnum:0,
                 pagesize:20,
                 pagenums:[],
               },
               sourcelist:{
                 macd:{
                     title: "### MACD 金叉计算公式 ###\n",
                     code:""+
                     "diff,dea,macd = MACD(PERIOD);\n"+
                     "ret = CROSS(diff,dea)\n"+
                      "retmacd = False ; \n"+
                     "if ret or ret[1] or ret[2] :\n"+
                      "       retmacd = True\n"+
                     "if retmacd == False:\n"+
                     "    kstop",
                     condition:"retmacd",
                     period:"C",
                     select:true,
                     dea:false,
                     
                 },
                 macdrelay:{
                     title: "### MACD 空中加油计算公式 ###\n",
                     code:""+
                     "diff,dea,macd = MACD(PERIODRELAY);\n"+
 
                      "retmacdrelay = False ; \n"+
                     "if dea > 0 and diff > dea and diff > diff[1] and diff[1] < diff[2] and diff[2] < diff[3]:\n"+
                      "       retmacdrelay = True\n"+
                     "if retmacdrelay == False:\n"+
                     "    kstop",
                     condition:"retmacdrelay",
                     period:"C",
                     select:false,
                 },
                 turn:{
                     title:"###  换手率计算公式 (3个周期有任意周期满足大于已填换手率的值)  ###\n",
                     code:""+
                     "retturn = 0\n"+
                     "if PERIODT > objturn or  PERIODT[1] > objturn or  PERIODT[2] > objturn:\n"+
                     "  retturn = 1\n"+
                     "if retturn == 0:"+
                     " kstop",
                     condition:"retturn",
                     period:"MT",
                     select:true,
                     objturn:"90",
                 },
                vol:{
                     title:"###  成交量放大公式  ###\n",
                     code:""+
                     "retvol = 0\n"+
                     "ma10vol = MA(PERIODV[1],10)\n"+
                     "ma10vol = ma10vol * 2\n"+
                     "if V < ma10vol:\n"+
                     "   kstop",
                     condition:"retvol",
                     period:"V",
                     select:true,
                 },
                 volatility:{
                     title:"###  横盘震荡公式  ###\n",
                     code:""+
                     "retvolatility = 0\n"+
                     "volati = TRANSVERSE(PERIOD_H,PERIOD_L,60)\n"+
                     "if volati >= 30:\n"+
                     "   kstop\n",
                     condition:"retvolatility",
                     period:"D",
                     select:true,
                 },
                 ma30:{
                     title:"###  上穿30日均线公式  ###\n",
                     code:""+
                     "retma30 = 0 \n"+
                     "ma30 = MA(PERIODMA,ma30objval)\n" +
                     "ret = CROSS(PERIODMA,ma30)\n"+
                     "if ret or ret[1]:\n" + 
                     " retma30 = 1\n"+
                     "if retma30==0:\n"+
                     "   kstop",
                     condition:"retma30",
                     period:"C",
                     select:true,
                     objval:30,
                 }
             },
             runconfs:{
                 showcode:false,
                 klangserver:false,
                 klangdate:false,
                 inputdate:""
             },				
             sourcecode:"",
             runcode:"",
             countdown:"",
             exec_code:[],
             plugin_show:false
              
           }
       },
   
      async created() {
         await getdefaultconfs();
       },

       async mounted () {

         var today = new Date();
         this.runconfs.inputdate = today.toLocaleDateString().replaceAll("/","-");
         this.make_code()
       },
       methods: {


         openbrowser:function(event){
             url = event.target.href
             event.preventDefault();
             shell.openExternal(url);
         },
         make_code(){
             //"macd","turn", "vol","ma30","volatility"
             var code = ""
             var condition = "if True "

             code += "PROGRESS(3);\n";

             if (this.runconfs.klangdate == true){

                 code += "date('2021-01-01','" + this.runconfs.inputdate +"')\n";
             }
             //macd
             if (this.sourcelist.macd.select == true) {
                 code += this.sourcelist.macd.title;
                 macd_period = "PERIOD = " + this.sourcelist.macd.period  + "\n";

                 code += macd_period + this.sourcelist.macd.code + "\n";

                 if (this.sourcelist.macd.dea == true){

                     //0 轴上方
                     code += " if dea < 0:\n" +
                             "    retmacd = False\n";
                 }

                  
             }
             
             //macd 空中加油
             if (this.sourcelist.macdrelay.select == true) {
                 code +=this.sourcelist.macdrelay.title;
                 relay_period = "PERIODRELAY = " + this.sourcelist.macdrelay.period  + "\n";
                 code += relay_period + this.sourcelist.macdrelay.code + "\n";
                  
             }

             //turn 
             if (this.sourcelist.turn.select == true) {
                 code +=this.sourcelist.turn.title;
                 turn_period = "PERIODT = " + this.sourcelist.turn.period  + "\n";
                 code += "objturn = " + this.sourcelist.turn.objturn + "\n";
                 code += turn_period + this.sourcelist.turn.code + "\n";
                  
             }
             
             //vol
             if (this.sourcelist.vol.select == true) {
                 code +=this.sourcelist.vol.title;
                 vol_period = "PERIODV = " + this.sourcelist.vol.period  + "\n";
                 code += vol_period + this.sourcelist.vol.code + "\n";
                  
             }

             //volatility
             if (this.sourcelist.volatility.select == true) {
                 code +=this.sourcelist.volatility.title;
                 if (this.sourcelist.volatility.period == "D"){
                     volatility_period = "PERIOD_H = H;\n"
                     volatility_period += "PERIOD_L = L;\n"
                 }

                 if (this.sourcelist.volatility.period == "W"){
                     volatility_period = "PERIOD_H = WH;\n"
                     volatility_period += "PERIOD_L = WL;\n"
                 }

                 
                 if (this.sourcelist.volatility.period == "M"){
                     volatility_period = "PERIOD_H = MH;\n"
                     volatility_period += "PERIOD_L = ML;\n"
                 }
                 
                 
                 code += volatility_period + this.sourcelist.volatility.code + "\n";
              
             }

             //ma30
             if (this.sourcelist.ma30.select == true) {
                 
                 code +=this.sourcelist.ma30.title;
                 code += "ma30objval =" +  this.sourcelist.ma30.objval + "\n";
                 ma30_period = "PERIODMA = " + this.sourcelist.ma30.period  + "\n";
                 code += ma30_period + this.sourcelist.ma30.code + "\n";
                  
             }

             var that = this;

             exec_codes = Object.values(this.exec_code)
             
             exec_codes.forEach(function(item){
                     
                 eval(item)
             })

             //condition += ":\n" +
             code += "\nDISPLAY(C);\n";
             
             this.sourcecode = code 

         }
       },
       watch:{

         "sourcelist.macd.select":function(newval,old){

             this.make_code()
         },
         "sourcelist.macd.dea":function(newval,old){

             this.make_code()//0轴上方
         },
         "sourcelist.macdrelay.select":function(newval,old){

             this.make_code() //空中加油
         },
         "sourcelist.macdrelay.period":function(newval,old){

             this.make_code()
         },
         "sourcelist.macd.period":function(newval,old){
             this.make_code()
         },
         "sourcelist.volatility.select":function(newval,old){

             this.make_code()
         },
         "sourcelist.volatility.period":function(newval,old){

             this.make_code()
         },			
         "sourcelist.turn.select":function(newval,old){

             this.make_code()
         },

         "sourcelist.turn.period":function(newval,old){
             this.make_code()
         },
         "sourcelist.turn.objturn":function(newval,old){
             this.make_code()
         },
         
         "sourcelist.vol.select":function(newval,old){

             this.make_code()
         },
         "sourcelist.vol.period":function(newval,old){
             this.make_code()
         },

         "sourcelist.ma30.select":function(newval,old){

             this.make_code()
         },
         "sourcelist.ma30.period":function(newval,old){
             this.make_code()
         },
         "sourcelist.ma30.objval":function(newval,old){
             this.make_code()
         },
         "runconfs.klangdate":function(newval,old){
             var today = new Date();
             this.runconfs.inputdate = today.toLocaleDateString().replaceAll("/","-");
             this.make_code()

         },
         "runconfs.inputdate":function(newval,old){
             this.make_code()
         },

         "runconfs.klangserver":function(newval,old){
             if (this.runconfs.klangserver == true){
                 iohost = "https://klang.org.cn:8099/user";

             } else {
                 iohost = "http://127.0.0.1:9088/user"
             }

             newconnect(iohost)
             vue.$data.online = 0
         }

       }
     }//VueApp
 
     


     var minute,second;// 分 秒

     function start_count()//开始
     {
         minute=second=0;//初始化
         int=setInterval(timer_count,1000);
     }

     function timer_count()//计时
     {
         second = second+1;


         if(second>=60)
         {
             second=0;
             minute=minute+1;
         }


         vue.$data.countdown = minute +'分'+second+'秒';

     }

     function stop_count()//暂停
     {
         window.clearInterval(int);
     }


     var socket;
     function newconnect(host){
         socket = io(host)
         socket.on("connect",(data)=>{
             console.log("connect")
             vue.$data.online = 1
         })
         socket.on("disconnect",(data)=>{
             console.log("disconnect")
             vue.$data.online = 0
             vue.$data.server_count = 0
             socket.connect()
         })

         socket.on("u_done",data=>{
             console.log("u_done",data)
             vue.$data.work = 0
             vue.$data.runcode = ""
             stop_count();

         })

         socket.on("u_info",data=>{
             console.log("u_info",data,data.servers.length)
             vue.$data.server_count = data.servers.length

         })

         socket.on("u_ret",data=>{
             console.log("u_ret",data)
             if (data.retcode=="ERROR"){
                 alert("系统正在执行其他任务，请稍等");
             } 
             if (data.retcode=="DISPLAY"){
                 code = data.code.replace(".","")
                 hqltsz = data.hqltsz.toFixed(2)
                 tdxbk = data.tdxbk
                 tdxgn = data.tdxgn
                 

                 value = data.value
                     
                 vue.$data.result.push({name:data.name,code:code,value:value,hqltsz:hqltsz,tdxbk:tdxbk,tdxgn:tdxgn})
                             
             }  

             if (data.retcode=="PROGRESS"){
                 code = data.code.replace(".","")
                 vue.$data.runcode = code 

             }
                        
         })



     } //new connect






     function send_task(){
             vue.$data.result = []
              
             vue.$data.work = true

             socket.emit("uexec_event",{content:vue.$data.sourcecode,loop:true});
     }

     
     function run_exec (event) {
               
         
               console.log(vue.$data.online)
               
               if (vue.$data.work){
                 vue.$data.toask.content = "我在计算中，你别总点我"
                 vue.$data.toask.state = 1
                 return 
               }

               if (vue.$data.server_count == 0){
                 alert("等待服务器启动,请稍后")
                 return 
               }

               send_task();
               start_count();
              
     }

     function appinit(message){

         plugindata = JSON.parse(message)

         console.log(plugindata)
         
         let i,length = plugindata.length;

         // 1. html
         htmls = []
         for (i=0;i<length;i++)
         {
             htmls.push(plugindata[i].html.join("").format(plugindata[i].id))
         }
         

         htmls.forEach(function(item){
             document.querySelector('#plugin_html').innerHTML += item
         })
 

         window.app  = Vue.createApp(VueApp)
         window.vue  =  app.mount('#app')

         // 2. sourcelist
         for (i=0;i<length;i++)
         { 
             sourceconf = plugindata[i].sourceconf
             sourceconf.code = sourceconf.code.join("").format(plugindata[i].id)
         

             vue.$data.sourcelist[plugindata[i].id] = sourceconf
         }

         // 3. code
         for (i=0;i<length;i++)
         { 
             exec_code = plugindata[i].exec_code.join("").format(plugindata[i].id)
             vue.$data.exec_code[plugindata[i].id] = exec_code
         }
         // 4. watch
         for (i=0;i<length;i++)
         { 
             plugindata[i].watch.forEach(function(name){
                 vue.$watch("sourcelist." + plugindata[i].id + "." + name,function(newVal,oldVal){
                     vue.make_code()
                 })
             })
         }




         newconnect(iohost)
         
         
         vue.$data.plugin_show = 1

         var run = document.querySelector('#run');
         var reconnect = document.querySelector('#connect');
         var updatedata = document.querySelector('#updatedata');
         var downloaddata = document.querySelector('#downloaddata');
         var restart_server = document.querySelector('#restart_server');
         var stop_server = document.querySelector('#stop_server');

         run.onclick = run_exec
         
         
         updatedata.onclick = function(event){
             socket.emit("u_cmd_event",{content:"UPDATEALL"});
         }
 
         downloaddata.onclick = function(event){
             download_data_zip();
         }
         reconnect.onclick = function(event){
             newconnect(iohost)
         }
         restart_server.onclick = function(event){
             reset_server(); //renderer.js
         }
         stop_server.onclick = function(event){
             stop_server_func(); //renderer.js
         }
         

     }

     window.appinit = appinit
</script>